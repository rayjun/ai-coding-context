---
name: monitoring-security
description: 监控基础设施部署的安全指南，包括身份验证、HTTPS 和最小权限访问。当设置 Prometheus、Grafana 或需要安全加固的类似监控系统时使用。
---

# 监控安全指南

**在部署监控系统（Prometheus、Grafana、告警）时使用此技能以确保正确的安全配置。**

## 核心安全原则

### 1. 身份验证要求

所有监控端点必须使用身份验证保护：

- **基本身份验证**：所有部署的最低要求
  - 使用强随机生成的密码（至少 16 个字符）
  - 将凭据存储在环境变量或密钥管理中
  - 永远不要将凭据提交到版本控制

- **集成身份验证**：
  - 配置 Prometheus 在抓取受保护端点时进行身份验证
  - 在 Prometheus 抓取配置中使用 `basic_auth` 配置
  - Grafana 数据源必须包含身份验证凭据

### 2. HTTPS/TLS 强制执行

- **生产部署必须使用 HTTPS**
- 仅在开发/测试环境下，HTTP 可接受的情况：
  - 仅在 localhost 上运行
  - 在终止 TLS 的反向代理后面
  - 明确记录为仅供开发使用

- **TLS 配置**：
  - 使用现代 TLS 版本（TLS 1.2 最低，优先使用 TLS 1.3）
  - 仅使用强加密套件
  - 从受信任的 CA 获取证书或使用有效的自签名证书

### 3. 网络隔离

- **容器网络**：为监控组件使用专用的 Docker 网络
- **端口暴露**：仅暴露需要外部访问的端口
- **防火墙规则**：尽可能按 IP/网络限制对监控服务的访问

### 4. 访问控制

- **最小权限**：授予最小必要权限
- **基于角色的访问**：在可用时使用 Grafana 的内置 RBAC
- **只读访问**：除非需要写入权限，否则将用户默认为查看者角色

### 5. 密钥管理

**永远不要存储敏感数据在：**
- Git 仓库
- Docker 镜像
- 版本控制中的配置文件
- 提交到 git 的 docker-compose.yml 中的环境变量

**应将密钥存储在：**
- `.env` 文件（添加到 .gitignore）
- Docker secrets
- 外部密钥管理（Vault、AWS Secrets Manager 等）
- 加密配置存储

### 6. 安全头

在反向代理（Nginx、Traefik）中配置安全头：

```
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

## 安全验证清单

部署到生产环境之前，请验证：

- [ ] 所有端点都需要身份验证
- [ ] HTTPS 已启用且正常工作
- [ ] 未使用默认密码
- [ ] 凭据安全存储（不在 git 中）
- [ ] 网络访问已适当限制
- [ ] 安全头已配置
- [ ] 监控数据保留策略已定义
- [ ] 日志访问和审计跟踪已启用

## 要避免的常见安全反模式

**不要：**
- 在没有身份验证的情况下将监控服务直接暴露到互联网
- 使用默认凭据（admin/admin 等）
- 将 `.env` 文件或密钥提交到 git
- 以 root 身份运行监控服务
- 允许匿名访问指标端点
- 在生产环境中使用未经适当验证的自签名证书

**要：**
- 在所有端点上使用强身份验证
- 为每个安装生成唯一密码
- 使用环境变量进行配置
- 以非 root 用户身份运行服务
- 即使对于"只读"指标也需要身份验证
- 使用适当的证书管理

## 快速启动安全配置

### 最小安全设置

1. **生成强凭据：**
   ```bash
   # 生成随机密码（至少 16 个字符）
   openssl rand -base64 24
   ```

2. **创建 .env 文件（添加到 .gitignore）：**
   ```bash
   ADMIN_USER=admin
   ADMIN_PASSWORD=<生成的密码>
   ```

3. **在 docker-compose.yml 中配置身份验证：**
   ```yaml
   environment:
     - ADMIN_USER=${ADMIN_USER}
     - ADMIN_PASSWORD=${ADMIN_PASSWORD}
   ```

4. **验证安全性：**
   - 测试未经身份验证的访问被阻止
   - 确认 HTTPS 重定向正常工作（如果启用）
   - 检查 git 历史记录中没有敏感数据

## 特定环境指南

### 开发环境
- 基本身份验证已足够
- 在 localhost 上可接受 HTTP
- 明确记录为"仅供开发"
- 仍然需要身份验证

### 生产环境
- HTTPS 强制性
- 需要强密码
- 强制执行网络隔离
- 定期安全审计
- 监控的监控（元监控）
- 监控基础设施的事件响应计划

## 安全文档要求

在部署监控时，记录：

1. **身份验证方法**：用户如何进行身份验证
2. **凭据存储**：密钥存储在哪里
3. **网络架构**：什么可以访问什么
4. **TLS 配置**：证书管理方法
5. **备份安全**：监控数据备份如何保护
6. **访问审查**：审查和撤销访问的流程

## 集成安全

在将监控与应用程序集成时：

- **抓取配置**：对所有抓取目标使用身份验证
- **推送网关**：推送端点需要身份验证
- **告警**：保护 webhook 端点和通知渠道
- **API 访问**：使用 API 密钥/令牌，而不是用户密码

## 参考资料

有关实施细节，请参阅：
- Docker Compose 安全配置示例
- Nginx 反向代理安全模板
- Prometheus 安全最佳实践文档
- Grafana 安全加固指南
